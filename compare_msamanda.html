<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <style>
      .tooltip-item {
        display: flex;
        align-items: center;
        margin-top: 5px;
      }

      .tooltip-color {
        width: 8px;
        height: 8px;
        margin-right: 5px;
      }

      .tooltip {
        position: absolute;
        background-color: rgb(186, 34, 34);
        border: 1px solid #ccc;
        padding: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        font-size: 12px;
        color: #333;
        visibility: hidden;
      }
      .flexcontainer {
        background-color: #ffffff;
        display: flex; 
        flex-wrap: wrap;
        border-radius: 10px; 
        padding: 10px;
        margin-left: 40px;
        margin-bottom: 4px;
        margin-right: 40px;
        margin-top: 4px;
        opacity: 0.8;
        border-color: #131d01;
        border-width: 0px;
        width: 100%;
        border-style: solid;
        align-content: center;
      }

      .flexcolumn {
        background-color: #c0c0c0; 
        display: flex; 
        flex-wrap: wrap;
        border-radius: 10px; 
        padding: 10px;
        padding-top: 10px ;
        margin-left: 4px;
        margin-bottom: 4px;
        margin-right: 4px;
        margin-top: 4px;
      }  
    </style>

    <title>CAMPI3 datavisualisatie</title>

    <script type="text/javascript" src="./d3.v5.js"></script>
    <link rel="stylesheet" href="jl.css">
    <link href="./node_modules/nouislider/dist/nouislider.css" rel="stylesheet">
    <script src="./node_modules/nouislider/dist/nouislider.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js" charset="utf-8"></script>

  </head>

  <body>
    <header>
      <a href="#"><img src="" alt="" width="20%" height="90" id="Insert_logo" style="background-color: #C6D580; display:block;" /></a>
    </header>

    <div class="container">
      <div class="sidebar1">
        <ul class="nav">
          <li><a href="./index.html">Infopagina</a></li>
          <li><a href="./upset.html">UpSet plots</a></li>
          <li><a href="./barplot_nr_of_mpsms.html">Barplots # mPSMs</a></li>
          <li><a href="./compare_msamanda.html">Comparison MSAmanda</a></li>
          <li><a href="./compare_ms2rescore.html">Comparison MS²Rescore</a></li>
          <li><a href="./tda.html">TDA: Histogram & PP plots</a></li>
          <!-- <li><a href="./histogram.html">TDA: distributies</a></li>   
          <li><a href="./pp_plots.html">TDA: PP plots</a></li> -->
          <!-- <li><a href="./taxonomic_distribution.html">Taxonomic distribution</a></li>
          <li><a href="./sample_composition_charts_v3.html">sample composition</a></li>             
          <li><a href="#">MS²Rescore fts PCA</a></li>
          <li><a href="#">MS²Rescore fts boxplots</a></li> -->
        </ul>
        <aside>
          <p> The above links demonstrate a basic navigational structure using an unordered list styled with CSS. Use this as a starting point and modify the properties to produce your own unique look. If you require flyout menus, create your own using a Spry menu, a menu widget from Adobe's Exchange or a variety of other javascript or CSS solutions.</p>
          <p>If you would like the navigation along the top, simply move the ul to the top of the page and recreate the styling.</p>
        </aside>
      </div>

      <article class="content">
  
        <section>
          <h2>Grouped bar chart</h2>

          <form>
            <div style="padding-left: 20px;">
            
              <label aria-label="criterium input">
                y-axis: &nbsp;
                <select name="yaxis" id="criterium">
                  <option value="scans">scans</option>
                  <option value="PSMs">PSMs</option>
                  <option value="peptides">peptides</option>
                  <option value="peptidoforms">peptidoforms</option>
                </select>
                <i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i>
              </label>
            
              <label aria-label="threshold input">
                q-value cut-off: &nbsp;
                <select name="threshold" id="threshold">
                  <option value="0.001">0.1 %</option>
                  <option value="0.01" selected="selected">1 %</option>
                  <option value="0.05">5 %</option>
                  <option value="1">none</option>
                </select>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              </label>
            </div>         
          </form>


          <div id='myDiv'></div>
          <div class="flexcontainer">
            <div id='lineDivPcs' style="display: flex; flex-wrap: wrap; width: 40%;"></div>    
            <div id='lineDivCounts' style="display: flex; flex-wrap: wrap; width: 40%;"></div>                    
          </div>
          <div id='lineDivPcsFullWidth'></div>

          
          <script>
            // Convert a string representation of a numeric list to an actual list of numbers
            function stringToNumericList(listAsString) {
              return listAsString
                .slice(1, -1)
                .split(', ')
                .map(Number);
            }

            // Convert a string representation of a list of strings to an actual list of strings
            function stringToListWStrings(listAsString) {
              return listAsString
                .slice(1, -1)
                .split(', ')
                .map(d => d.slice(1, -1));
            }

            async function fetchCSV(url) {
              const response = await fetch(url);
              const text = await response.text();
              return text;
            }


            let countValue = document.getElementById('criterium').value;
            let thresholdValue = document.getElementById('threshold').value;


            // Event listener for input change
            async function handleInputChange(event) {
              const inputElement = event.target;
              const inputValue = inputElement.value;

              switch (inputElement.id) {
                case 'criterium':
                  countValue = inputValue;
                  break;
                case 'threshold':
                  thresholdValue = inputValue;
                  break;
              }

              console.log('criterium:', countValue);
              console.log('threshold:', thresholdValue);

              const inputDir = './data/compare_msamanda'

              const filename = thresholdValue != 1 ? `${inputDir}/compare_msamanda.tsv` : `${inputDir}/compare_msamanda_nofilter.tsv`

              try {
                const csvData = await fetchCSV(`${filename}`);

                // Parse the main CSV data
                const rows = csvData.trim().split('\n').map(row => row.split('\t'));
                const headers = rows[0];
                const data = rows.slice(1).map(row => {
                  const obj = {};
                  headers.forEach((header, i) => {
                    obj[header] = row[i];
                  });
                  return obj;
                });

                console.log(filename);
                console.log(data)

                const filteredData = data
                  .filter(d => d.threshold == thresholdValue)
                  .filter(d => d.criterium == countValue)
                  .map(d => ({
                    ...d,
                    samples: stringToListWStrings(d.samples),
                    counts: stringToNumericList(d.counts)
                  }));

                const chart2Data = await fetchCSV(`${inputDir}/compare_msamanda_linechart.tsv`);
                const rows2 = chart2Data.trim().split('\n').map(row => row.split('\t'));
                const headers2 = rows2[0];
                const data2 = rows2
                  .slice(1).map(row => {
                    const obj = {};
                    headers2.forEach((header, i) => {
                      obj[header] = row[i];
                    });
                  return obj;
                });


                const lineChartData = data2
                .filter(d => d.threshold == thresholdValue)
                .filter(d => d.criterium == countValue)
                .map(d => ({
                  ...d,
                  pcs: stringToNumericList(d.pcs),
                  counts: stringToNumericList(d.new_counts)
                }))

                console.log(lineChartData)

                const colorScheme = ["#fc8d62","#ffd92f","#a6d854","#66c2a5","#8da0cb","#e78ac3"]
                const colorSchemeBorder = ["#e27043","#e0c23b","#97c64d","#5aab91","#798ab1","#d27cb1"]

                const methods = [
                  { method: 'first', name: '0', color: colorScheme[0], lineColor: colorSchemeBorder[0], order: 1 },
                  { method: 'MaxPrec1', name: '1', color: colorScheme[1], lineColor: colorSchemeBorder[1], order: 2 },
                  { method: 'MaxPrec2', name: '2', color: colorScheme[2], lineColor: colorSchemeBorder[2], order: 3 },
                  { method: 'MaxPrec3', name: '3', color: colorScheme[3], lineColor: colorSchemeBorder[3], order: 4 },
                  { method: 'MaxPrec4', name: '4', color: colorScheme[4], lineColor: colorSchemeBorder[4], order: 5 },
                  { method: 'MaxPrec5', name: '5', color: colorScheme[5], lineColor: colorSchemeBorder[5], order: 6 },
                ];

                var y1Data = {}, xData = {}, traces = [];

                methods.forEach(m => {
                  const chartData = filteredData.find(d => d.method == m.method);
                  y1Data[m.method] = chartData.counts;
                  xData[m.method] = chartData.samples;

                  // Create trace for the bar chart
                  traces.push({
                    x: xData[m.method],
                    y: y1Data[m.method],
                    name: m.name,
                    type: 'bar',
                    marker: {
                      color: m.color,
                      line: {
                        color: m.lineColor,
                        width: 1.5
                      }
                    }
                  });
                });

                var traces2 = [], traces3 = [], traces4=[]
                lineChartData.forEach(d => {
                  console.log(d.sample, d.pcs)
                  traces2.push({
                    x: [1, 2, 3, 4, 5],
                    y: d.counts,
                    name: d.sample,
                    type: 'scatter',
                    mode: 'lines'
                  });
                  traces3.push({
                    x: [1, 2, 3, 4, 5],
                    y: d.pcs,
                    name: d.sample,
                    type: 'scatter',
                    mode: 'lines'                    
                  })
                })

                const layout = {
                  barmode: 'group',
                  bargap: 0.15,
                  bargroupgap: 0.2,
                  showlegend: true,
                  autosize: false,
                  width: 760,
                  height: 500,  
                  legend: {
                  //   // title: {text: 'Max number of different precursors'},
                    y: 0.5,
                  //   bordercolor: 'black',
                  //   borderwidth: 1.5,
                  },
                  yaxis: {
                    title: {
                      text: `number of target ${countValue} (${thresholdValue*100}% FDR)`,
                      // text: `number of target PSMs`,
                      standoff: 20,
                      },                      
                    // titlefont: {
                    //     family: 'Arial, sans-serif',
                    //     size: 18,
                    //     color: 'grey'
                    //     },
                    // dtick: 25000,
                    tick0: 0,
                  },
                  title: {
                    text: `Number of identified ${countValue} (${thresholdValue*100}% FDR)`,
                    // text: `number of target PSMs`,
                    font: {
                        family: 'Arial, sans-serif',
                        size: 20,
                        color: 'darkgrey',                
                        },
                    x: 0.5,
                    y: 5,
                    xref: 'paper',
                    yref: 'paper',
                    xanchor: 'center',
                    yanchor: 'top',
                  },                
                  margin: {
                    l: 100,
                    r: 50,
                    b: 100,
                    t: 80,
                    pad: 4
                  },
                };

                const layout2 = {
                  // showlegend: false,
                  autosize: false,
                  height: 500,
                  width: 400,
                  xaxis: {
                    showgrid: false,
                    range: [0.5, 5.5],
                    dtick: [1],
                    tick0: 1,
                  },
                }

                const yAxis_pcs = {
                    range: [-1, 101],
                    dtick: 25,
                    tick0: 0,
                    ticksuffix: '%',
                    showticksuffix: 'last',
                  };

                const layout3 = {
                  // showlegend: false,               
                  autosize: false,
                  height: 500,
                  width: 400,
                  xaxis: {
                    showgrid: false,
                    range: [0.5, 5.5],
                    dtick: 1,
                    tick0: 1,
                  },
                  yaxis: yAxis_pcs,
                }

                const layout4 = {
                  // showlegend: false,
                  autosize: false,
                  height: 500,
                  width: 800,
                  xaxis: {
                    showgrid: false,
                    range: [0.9, 5.1],
                    dtick: 1,
                    tick0: 1,
                  },                  
                  yaxis: yAxis_pcs,
                }
                myDiv.fn = `compare_msamanda_${countValue}_${thresholdValue}`
                Plotly.newPlot('myDiv', traces, layout);
                lineDivPcsFullWidth.fn = `compare_msamanda_pcs_${countValue}_${thresholdValue}`
                Plotly.newPlot('lineDivCounts', traces2, layout2);
                Plotly.newPlot('lineDivPcs', traces3, layout3);
                Plotly.newPlot('lineDivPcsFullWidth', traces3, layout4);
              } catch (error) {
                console.error('Error fetching CSV:', error);
              }
            }

            // Add event listeners for input elements
            document.getElementById('criterium').addEventListener('input', handleInputChange);
            document.getElementById('threshold').addEventListener('input', handleInputChange);

          </script>
          

        </section>


        <section>
          <h2>Logo Replacement</h2>
        </section>
      </article>


      <aside>
        <h4>Backgrounds</h4>
        <p>By nature, the background color on any block element will only show for the length of the content. If you'd like a dividing line instead of a color, place a border on the side of the .content block (but only if it will always contain more content).</p>
      </aside>

      <footer>
        <p> </p>
        <address>
            
        </address>
      </footer>
    </div>
  </body>
</html>