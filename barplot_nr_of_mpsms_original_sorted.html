<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <style>
      .tooltip-item {
        display: flex;
        align-items: center;
        margin-top: 5px;
      }

      .tooltip-color {
        width: 8px;
        height: 8px;
        margin-right: 5px;
      }

      .tooltip {
        position: absolute;
        background-color: rgb(186, 34, 34);
        border: 1px solid #ccc;
        padding: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        font-size: 12px;
        color: #333;
        visibility: hidden;
      }
      .flexcontainer {
        background-color: #ffffff;
        display: flex; 
        flex-wrap: wrap;
        border-radius: 10px; 
        padding: 10px;
        margin-left: 40px;
        margin-bottom: 4px;
        margin-right: 40px;
        margin-top: 4px;
        opacity: 0.8;
        border-color: #131d01;
        border-width: 0px;
        width: 100%;
        border-style: solid;
        align-content: center;
      }

      .flexcolumn {
        background-color: #c0c0c0; 
        display: flex; 
        flex-wrap: wrap;
        border-radius: 10px; 
        padding: 10px;
        padding-top: 10px ;
        margin-left: 4px;
        margin-bottom: 4px;
        margin-right: 4px;
        margin-top: 4px;
      }  
    </style>

    <title>CAMPI3 datavisualisatie</title>

    <script type="text/javascript" src="../d3.v5.js"></script>
    <link rel="stylesheet" href="../jl.css">
    <link href="../node_modules/nouislider/dist/nouislider.css" rel="stylesheet">
    <script src="../node_modules/nouislider/dist/nouislider.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js" charset="utf-8"></script>

  </head>

  <body>
    <header>
      <a href="#"><img src="" alt="" width="20%" height="90" id="Insert_logo" style="background-color: #C6D580; display:block;" /></a>
    </header>

    <div class="container">
      <div class="sidebar1">
        <ul class="nav">
          <li><a href="./index.html">Infopagina</a></li>
          <li><a href="./upset.html">UpSet plots</a></li>
          <li><a href="./barplot_nr_of_mpsms.html">Barplots # mPSMs</a></li>
          <li><a href="./compare_msamanda.html">Comparison MSAmanda</a></li>
          <li><a href="./compare_ms2rescore.html">Comparison MS²Rescore</a></li>
          <li><a href="./tda.html">TDA: Histogram & PP plots</a></li>
          <!-- <li><a href="./histogram.html">TDA: distributies</a></li>   
          <li><a href="./pp_plots.html">TDA: PP plots</a></li> -->
          <!-- <li><a href="./taxonomic_distribution.html">Taxonomic distribution</a></li>
          <li><a href="./sample_composition_charts_v3.html">sample composition</a></li>             
          <li><a href="#">MS²Rescore fts PCA</a></li>
          <li><a href="#">MS²Rescore fts boxplots</a></li> -->
        </ul>
        <aside>
          <p> The above links demonstrate a basic navigational structure using an unordered list styled with CSS. Use this as a starting point and modify the properties to produce your own unique look. If you require flyout menus, create your own using a Spry menu, a menu widget from Adobe's Exchange or a variety of other javascript or CSS solutions.</p>
          <p>If you would like the navigation along the top, simply move the ul to the top of the page and recreate the styling.</p>
        </aside>
      </div>

      <article class="content">
  
        <section>
          <h2>Grouped bar chart</h2>

          <form  class="flexcontainer">
            <div  id="metadata" class="flexcolumn" style="width: 25%;">
              <div class="inputbox" style="width: 100%;">
                <label for="sample">sample: &nbsp;</label>
                <select id="sample" name="sample"  style="width: 60px; ">
                  <option value="F01">F01</option>
                  <option value="F06">F06</option>
                  <option value="F07">F07</option>
                  <option value="S03">S03</option>
                  <option value="S05">S05</option>
                  <option value="S07">S07</option>
                  <option value="S08">S08</option>
                  <option value="S11">S11</option>
                </select>
              </div>
              <div class="inputbox" style="width: 100%;">
                <input type="checkbox" id="scoring" value="true" onclick="toggleSelectScoring()">
                <label for="scoring">MS²Rescore</label>
              </div>
              <div  class="inputbox" style="width: 100%;">
                  <label for="scoringMethod">Scoring: &nbsp;</label>
                  <select name="scoring" id="scoringMethod" style="width: 80px; " >
                    <option value='msamanda'>MSAmanda</option> 
                    <option value='ms2rescore' selected="selected">MS²Rescore</option>
                  </select>

                  <label for="version">Scoring: &nbsp;</label>
                  <select id="version" style="width: 80px; " >
                    <option value='default' selected="selected">start</option> 
                    <option value='final'>adapted</option>
                  </select>
              </div>
              <div id="select-method-container"  class="inputbox" style="width: 100%;">
                <label for="method">Method: &nbsp;</label>
                <select name="method" id="method" style="width: 80px; " >

                    <option value='first'>first</option>
                    <option value='MaxPrec1'>max 1 prec</option>              
                    <option value='MaxPrec2'>max 2 prec</option>
                    <option value='MaxPrec3'>max 3 prec</option>
                    <option value='MaxPrec4'>max 4 prec</option>
                    <option value='MaxPrec5'>max 5 prec</option>
                    <option value='all' selected="selected">all</option>
                    <option value='second'>second (ms2rescore)</option>
                    <option value='merged'>merged (ms2rescore)</option>
                </select>
              </div>
            </div>        
            <div id="data-processing" class="flexcolumn" style="width: 30%;">

              <div aria-label="rank-input" class="inputbox" style="width: calc(100% - 20px);">
                  <label for="selectrank">Select rank: &nbsp;</label>
                  <select name="selectrank" id="selectrank" style="width: 120px;">
                      <option value='rank1'>Rank 1 PSMs</option>
                      <option value='allranks'>All PSMs</option>
                  </select>
              </div>
              <div class="inputbox">
                <div>
                  <input type="checkbox" id="logtransform" value="true" onclick="toggleSelectBase()">
                  <label for="logtransform">Log-transform</label>
                </div>              
                <div id="selectlogbase-container">
                  <label for="logbase">Base: &nbsp;</label>
                  <select name="selectbase" id="logbase">
                      <option value=2 selected="selected">2</option>
                      <option value=10>10</option>
                  </select>
                </div>
              </div>
            </div>
            <div aria-label="layout-input" class="flexcolumn" style="width: 30%">
                
              <div class="inputbox">
                <label for="nr_of_bins">Number of bins</label>
                <input type="number" id="nr_of_bins" name="quantity" min="10" max="500" value="300">
              </div>
                              
              <div class="inputbox">
                <label for="binsize">Size of bins:</label>
                <input type="number" id="binsize" name="quantity" min="0.001" max="10" value="0.05">
              </div>
                              
              <div class="inputbox">
                <input type="checkbox" id="zoom" value=[-5,3]>
                <label for="zoom">Zoom &nbsp;</label>
              </div>
            </div>
            <label aria-label="threshold input">
              q-value cut-off: &nbsp;
              <select name="threshold" id="threshold">
                <option value="0.001">0.001</option>
                <option value="0.01" selected="selected">0.01</option>
                <option value="0.05">0.05</option>
                <option value="1.0">None</option>
              </select>
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          </form>


          <div id='myDiv'></div>
          <div class="flexcontainer">
            <!-- <div id='lineDivPcs' style="display: flex; flex-wrap: wrap; width: 40%;"></div>    
            <div id='lineDivCounts' style="display: flex; flex-wrap: wrap; width: 40%;"></div>                     -->
          </div>
          <!-- <div id='lineDivPcsFullWidth'></div> -->

          <div id="DivBarplot" style="width: 100%"></div>
          
          <script>
            // Convert a string representation of a numeric list to an actual list of numbers
            function stringToNumericList(listAsString) {
              return listAsString
                .slice(1, -1)
                .split(', ')
                .map(Number);
            }

            // Convert a string representation of a list of strings to an actual list of strings
            function stringToListWStrings(listAsString) {
              return listAsString
                .slice(1, -1)
                .split(', ')
                .map(d => d.slice(1, -1));
            }

            async function fetchCSV(url) {
              const response = await fetch(url);
              const text = await response.text();
              return text;
            }


            let sampleValue = document.getElementById('sample').value;
            let thresholdValue = document.getElementById('threshold').value;
            let methodValue = document.getElementById('method').value;
            let versionValue = document.getElementById('version').value;
            let scoringValue = document.getElementById('scoringMethod').value;


            // Event listener for input change
            async function handleInputChange(event) {
              const inputElement = event.target;
              const inputValue = inputElement.value;

              switch (inputElement.id) {
                case 'sample':
                  sampleValue = inputValue;
                  break;
                case 'threshold':
                  thresholdValue = inputValue;
                  break;
                case 'method':
                  methodValue = inputValue;
                  break;
                case 'scoringMethod':
                  scoringValue = inputValue;
                  break;
                case 'version':
                  versionValue = inputValue;
                  break;
              }

              try {
                const csvData = await fetchCSV(`./data/barplot_nr_of_mpsms.tsv`);

                // Parse the main CSV data
                const rows = csvData.trim().split('\n').map(row => row.split('\t'));
                const headers = rows[0];
                const data = rows.slice(1).map(row => {
                  const obj = {};
                  headers.forEach((header, i) => {
                    obj[header] = row[i];
                  });
                  return obj;
                });

                // const samples = ['F01', 'F06', 'F07', 'S03','S05','S07','S08','S11']

                console.log('sample:', sampleValue);
                console.log('threshold:', thresholdValue);
                console.log('method: ', methodValue);
                console.log('version: ', versionValue);
                console.log('scoring: ', scoringValue);


                var filteredData = data
                  // .filter(d => d.sample == sampleValue)
                  .filter(d => d.threshold == thresholdValue)
                  .filter(d => d.version == versionValue)
                  .filter(d => d.scoring == scoringValue)
                  .filter(d => d.method == methodValue)
                  .sort((a, b) => b[2]-a[2]);

                console.log(filteredData)

                let samples = [];

                filteredData.forEach((d) => {
                  samples.push(d.sample)
                })
                samples = ['S03','S05','S07','S08','S11','F01','F06','F07'];
                              
                const colors = ['red','darkorange','gold','limegreen','aquamarine','cornflowerblue', 'mediumpurple', 'hotpink']
                const colorsBorders = ['crimson','chocolate','goldenrod','darkgreen','mediumspringgreen','blue', 'indigo', 'mediumvioletred']

                let sampleData = [], traces = [], labelsBars = []

                for (let i=0; i < samples.length; i++) {
                  sample = samples[i]
                  sampleData = filteredData.filter(d => d.sample == sample)

                  let xValues = [], yValues = []


                  for (let j = 2; j < 7; j++) {
                    xValues.push(`${j}`);
                    yValues.push(Number(sampleData[0][j]))

                    let pc = Number(sampleData[0][j])/sampleData[0]['total']*100;

                    pc = (pc < 1 && pc != 0) ?  `< 1` : `${Math.round(pc*10)/10}`  

                    labelsBars.push({
                      x: j - 0.38 + i*0.106,
                      y: Number(sampleData[0][j])+300,
                      text: `${Number(sampleData[0][j])} (${pc}%)`,
                      xanchor: 'center',
                      yanchor: 'bottom',
                      textangle: -90,
                      showarrow: false,
                      font: {
                            color: colorsBorders[i]
                        }
                    })
                  };
                  traces.push({
                    x: xValues,
                    y: yValues,
                    name: sample, 
                    type: 'bar',
                    marker: {
                    color: colors[i],
                    line: {
                      color: colorsBorders[i],
                      width: 1.5
                    }
                  }
                  })
                  console.log(sample, yValues)
                }

                const layout = {
                  autosize: false,
                  // width: 860,
                  width: 1060,
                  height: 500,
                  margin: {
                    l: 50,
                    r: 50,
                    b: 100,
                    t: 150,
                    pad: 4
                  },

                  barmode: 'group',
                  bargap: 0.15,
                  bargroupgap: 0.2,

                  
                  
                  xaxis: {
                    range: [1.5,5.5],
                    title: `Number of identified peptides in one MS2 spectrum (${thresholdValue*100}% FDR)`,
                    tickvalues: [2, 3, 4, 5],
                    tickangle: -90,
                                   
                  },

                  yaxis: {
                    // showticklabels: false,
                    title: '# MS2 spectra',
                    tickangle: -90,
                    side: 'right'
                    
                  },
                  showlegend: false,
                  // showlegend: true,

                  legend: {
                    x: 1,
                    xanchor: 'right',
                    y: 1.01,
                    bordercolor: 'black',
                    borderwidth: 1.5,
                  },

                  annotations: labelsBars,

                  // title: {
                  //   text: `Number of MS2 spectra with mPSMs`,
                  //   font: {
                  //       // family: 'Arial, sans-serif',
                  //       size: 20,
                  //       color: 'darkgrey',                
                  //       },
                  //   x: 0.5,
                  //   y: 5,
                  //   xref: 'paper',
                  //   yref: 'paper',
                  //   xanchor: 'center',
                  //   yanchor: 'top',
                  // },  
                }


                DivBarplot.fn = `mPSMs_per_scan_${scoringValue}_${methodValue}_${versionValue}`
                Plotly.newPlot('DivBarplot', traces, layout);
              } catch (error) {
                console.error('Error fetching CSV:', error);
              }
            }

            // Add event listeners for input elements
            document.getElementById('sample').addEventListener('input', handleInputChange);
            document.getElementById('threshold').addEventListener('input', handleInputChange);
            document.getElementById('method').addEventListener('input', handleInputChange);
            document.getElementById('version').addEventListener('input', handleInputChange);
            document.getElementById('scoringMethod').addEventListener('input', handleInputChange);

          </script>
          

        </section>


        <section>
          <h2>Logo Replacement</h2>
        </section>
      </article>


      <aside>
        <h4>Backgrounds</h4>
        <p>By nature, the background color on any block element will only show for the length of the content. If you'd like a dividing line instead of a color, place a border on the side of the .content block (but only if it will always contain more content).</p>
      </aside>

      <footer>
        <p> </p>
        <address>
            
        </address>
      </footer>
    </div>
  </body>
</html>