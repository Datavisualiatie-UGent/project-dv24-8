<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <style>
      .tooltip-item {
        display: flex;
        align-items: center;
        margin-top: 5px;
      }

      .tooltip-color {
        width: 8px;
        height: 8px;
        margin-right: 5px;
      }

      .tooltip {
        position: absolute;
        background-color: rgb(186, 34, 34);
        border: 1px solid #ccc;
        padding: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        font-size: 12px;
        color: #333;
        visibility: hidden;
      }

      #criterium-container {
        display: none;
      }

      #selectlogbase-container {
        display: none;
      }

      #select-ms2rescore-method-container {
        display: none;
      }

      select {
        width: 60%;
        padding: 4px 4px;
        border-radius: 4px;
        background-color: #f1f1f1;
        text-align: center;
      }

      .flexcontainer {
        background-color: #ffffff;
        display: flex; 
        flex-wrap: wrap;
        border-radius: 10px; 
        padding: 10px;
        margin-left: 40px;
        margin-bottom: 4px;
        margin-right: 40px;
        margin-top: 4px;
        opacity: 0.8;
        border-color: #131d01;
        border-width: 0px;
        width: 100%;
        border-style: solid;
        align-content: center;
      }

      .flexcolumn {
        background-color: #c0c0c0; 
        display: flex; 
        flex-wrap: wrap;
        border-radius: 10px; 
        padding: 10px;
        padding-top: 10px ;
        margin-left: 4px;
        margin-bottom: 4px;
        margin-right: 4px;
        margin-top: 4px;
      }     
      .inputbox {
        background-color: #f0f0f0; 
        width: 100%;
        border-radius: 10px; 
        padding: 10px;
        margin-left:2px;
        margin-bottom: 2px;
        margin-right: 2px;
        margin-top: 2px;
      }
      .subchart{
        background-color: #f0f0f0; 
        width: 100%;
        padding: 0px;
        margin-left:20x;
        margin-bottom: 2px;
        margin-right: 0px;
        margin-top: 0px;        
      }

    </style>

    <title>CAMPI3 datavisualisatie</title>

    <script type="text/javascript" src="./d3.v5.js"></script>
    <link rel="stylesheet" href="jl.css">
    <link href="./node_modules/nouislider/dist/nouislider.css" rel="stylesheet">
    <script src="./node_modules/nouislider/dist/nouislider.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js" charset="utf-8"></script>

  </head>

  <body>
    <header>
      <a href="#"><img src="" alt="" width="20%" height="90" id="Insert_logo" style="background-color: #C6D580; display:block;" /></a>
    </header>

    <div class="container">
      <div class="sidebar1">
        <ul class="nav">
          <li><a href="./index.html">Infopagina</a></li>
          <li><a href="./upset.html">UpSet plots</a></li>
          <li><a href="./barplot_nr_of_mpsms.html">Barplots # mPSMs</a></li>
          <li><a href="./compare_msamanda.html">Comparison MSAmanda</a></li>
          <li><a href="./compare_ms2rescore.html">Comparison MS²Rescore</a></li>
          <li><a href="./tda.html">TDA: Histogram & PP plots</a></li>
          <!-- <li><a href="./histogram.html">TDA: distributies</a></li>   
          <li><a href="./pp_plots.html">TDA: PP plots</a></li> -->
          <!-- <li><a href="./taxonomic_distribution.html">Taxonomic distribution</a></li>
          <li><a href="./sample_composition_charts_v3.html">sample composition</a></li>             
          <li><a href="#">MS²Rescore fts PCA</a></li>
          <li><a href="#">MS²Rescore fts boxplots</a></li> -->
        </ul>
        <aside>
          <p> The above links demonstrate a basic navigational structure using an unordered list styled with CSS. Use this as a starting point and modify the properties to produce your own unique look. If you require flyout menus, create your own using a Spry menu, a menu widget from Adobe's Exchange or a variety of other javascript or CSS solutions.</p>
          <p>If you would like the navigation along the top, simply move the ul to the top of the page and recreate the styling.</p>
        </aside>
      </div>

      <article class="content">
      
        <section style="width: 100%">
          <h2>Histogram</h2>

          <form  class="flexcontainer">
            <div  id="metadata" class="flexcolumn" style="width: 25%;">
              <div class="inputbox" style="width: 100%;">
                <label for="sample">sample: &nbsp;</label>
                <select id="sample" name="sample"  style="width: 60px; ">
                  <option value="F01">F01</option>
                  <option value="F06">F06</option>
                  <option value="F07" selected="selected">F07</option>
                  <option value="S03">S03</option>
                  <option value="S05">S05</option>
                  <option value="S07">S07</option>
                  <option value="S08">S08</option>
                  <option value="S11">S11</option>
                </select>
              </div>
              <div class="inputbox" style="width: 100%;">
                <input type="checkbox" id="scoring" value="true" onclick="toggleSelectScoring()">
                <label for="scoring">MS²Rescore</label>
              </div>

              <div id="select-analysis-container"  class="inputbox" style="width: 100%;">
                  <label for="analysis">Method: &nbsp;</label>
                  <select name="analysis" id="analysis" style="width: 80px; " >
                      <option value='default' selected="selected">default</option>
                      <option value='final'>final</option>
                  </select>
              </div>

              <div id="select-ms2rescore-method-container"  class="inputbox" style="width: 100%;">
                  <label for="ms2rescoreMethod">Method: &nbsp;</label>
                  <select name="ms2rescore-method" id="ms2rescoreMethod" style="width: 90px; ">
                      <option value='first' selected="selected">first</option>
                      <option value='second'>second</option>
                      <option value='all'>all</option>
                      <option value='merged'>merged</option>
                  </select>
              </div>
            </div>
            
            <div id="data-processing" class="flexcolumn" style="width: 30%;">

              <div aria-label="criterium-input" class="inputbox" style="width: calc(100% - 20px);">
                  <label for="criterium">Select criterium: &nbsp;</label>
                  <select id="criterium" style="width: 120px;">
                      <option value='psms'>PSMs</option>
                      <option value='peptides' selected="selected">peptides</option>
                  </select>
              </div>
              <div class="inputbox">
                <div>
                  <input type="checkbox" id="logtransform" value="true" onclick="toggleSelectBase()">
                  <label for="logtransform">Log-transform</label>
                </div>              
                <div id="selectlogbase-container">
                  <label for="logbase">Base: &nbsp;</label>
                  <select name="selectbase" id="logbase">
                      <option value=2 selected="selected">2</option>
                      <option value=10>10</option>
                  </select>
                </div>
              </div>
            </div>

            <div aria-label="layout-input" class="flexcolumn" style="width: 30%">
                
                              
              <div class="inputbox">
                <label for="binsize">Size of bins:</label>
                <input type="number" id="binsize" name="quantity" min="0.001" max="10" value="0.05">
              </div>
                              
              <div class="inputbox">
                <input type="checkbox" id="zoom" value=[-5,3]>
                <label for="zoom">Zoom &nbsp;</label>
              </div>
            </div>
          </form>

          <label aria-label="threshold input">
            q-value cut-off: &nbsp;
            <select name="threshold" id="threshold">
              <option value="0.001">0.1 %</option>
              <option value="0.01" selected="selected">1 %</option>
              <option value="0.05">5 %</option>
            </select>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          </label>
        
          <div class="flexcontainer">
            <div class="inputbox" style="width: 40%";>        
              <input type="button" onclick="handleInputChange_histogram(event)" value="LET'S GOOOOO!!!!!"
                style="background-color: #6eb993; border-radius: 10px; color: white; padding: 16px 32px; text-decoration: none; cursor: pointer; width: 100%;">
            </div>   

            <div class="inputbox" style="width: 40%;"> 
              <input type="button" onclick="handleInputChange_PPplot(event)" value="pp plot"
                style="background-color: #6eb993; border-radius: 10px; color: rgb(62, 62, 62); padding: 16px 32px; text-decoration: none; cursor: pointer; width: 100%;">
            </div>     
          </div>

          <!-- <div id='upsetPlot'></div> -->
          <!-- <div id="upsetChart"></div> -->

          <div class="flexcontainer">
            <div id='upsetChart' class="subchart" style="width: 55%;"></div>
            <div  id="horbarChart" class="subchart" style="width: 15%;"></div>
          </div>

        </section>
  
        <section>
          <h2>Logo Replacement</h2>
        </section>
      </article>

      <aside>
        <h4>Backgrounds</h4>
        <p>By nature, the background color on any block element will only show for the length of the content. If you'd like a dividing line instead of a color, place a border on the side of the .content block (but only if it will always contain more content).</p>
      </aside>

      <footer>
        <p> </p>
        <address>
            
        </address>
      </footer>
    </div>      

    <script>
      function toggleSelectBase() {
        var logtransformCheckbox = document.getElementById('logtransform');
        var selectlogbaseContainer = document.getElementById('selectlogbase-container');

        if (logtransformCheckbox.checked) {
          selectlogbaseContainer.style.display = 'block';
        } else {
          selectlogbaseContainer.style.display = 'none';
        }
      };

      function toggleSelectScoring() {
        var ms2rescoreCheckbox = document.getElementById('scoring');

        if (ms2rescoreCheckbox.checked) {
           selectMethodContainer =  document.getElementById("select-ms2rescore-method-container");
           removeMethodContainer = document.getElementById("select-msamanda-method-container");
        } else {
          selectMethodContainer =  document.getElementById("select-msamanda-method-container");
          removeMethodContainer = document.getElementById("select-ms2rescore-method-container");
        };
        selectMethodContainer.style.display = 'block';
        removeMethodContainer.style.display = 'none';
      };

      async function fetchCSV(url) {
        const response = await fetch(url);
        const text = await response.text();
        return text;
      }

      async function handleInputChange_histogram(event) {if (event.type === 'click') {

        const sampleValue = document.getElementById('sample').value;
        // let binSize = document.getElementById('binsize').value;
        const criteriumValue = document.getElementById('criterium').value;
        const thresholdValue = document.getElementById('threshold').value;
        
        var scoringValue, analysisValue, logbaseValue;


        if (document.getElementById('scoring').checked) {
          scoringValue = 'ms2rescore';
          analysisValue = document.getElementById('ms2rescoreMethod').value;
          logbaseValue = false;
        } else {
          scoringValue = 'msamanda';
          analysisValue = document.getElementById('analysis').value;
          logbaseValue = document.getElementById('logbase').value;
        }

        console.log('Sample:', sampleValue, "&", 'Scoring:', scoringValue);
        console.log('Method:', analysisValue);
        console.log('Threshold', thresholdValue);
        console.log('selection: ', criteriumValue);

        try {
          // parse csv data with cutoff scores 
          const csvData = await fetchCSV(`./data/data_upset.csv`);
          const rows = csvData.trim().split('\n').map(row => row.split(','));
          const headers = rows[0];
          const data = rows.slice(1).map(row => {
            const obj = {};
            headers.forEach((header, i) => {
              obj[header] = row[i];
            });
            return obj;
          });

          const filteredData = data
            .filter(d => (d.sample==sampleValue)&&(d.threshold==thresholdValue))
            .filter(d => (d.analysis==analysisValue)&&(d.criterium==criteriumValue))
            .filter(d => (d.value != 0))
            .sort((a,b) => Number(b.value) - Number(a.value))
            .sort((a,b) => b.variable.length - a.variable.length)


          console.log('filteredData: ',filteredData);

          // const margin = {top: 50, right: 200, bottom: 300, left: 200};
          // const width = 50 * filteredData.length + 10;
          // const height = 400;

          
          const xData = filteredData.map((d) => d.variable)
          const yData = filteredData.map((d) => Number(d.value))

          let colors = [];

          xData.forEach((d) => {
            if (d.includes('A') && !d.includes('B')) {
              if (d.includes('C') && !d.includes('D')) {
                colors.push('purple')
              } else {
              colors.push('red')
              }} else {
              if (d.includes('C') && !d.includes('D')) {
                colors.push('cornflowerblue')
              } else {
                colors.push('rgba(62,62,62,1)')
              }
            }
          })


          const barsData = [{
            x: xData,
            y: yData,
            type: 'bar',                  
            marker: {
              // color: 'cornflowerblue',
              color: colors,
              // line: {
              //   color: 'rgb(84, 130, 214)',
              //   width: 1.5
              // }
            }
          }];

          const heightSubplotCircles = 100, widthSubplotCircles = 660;
          const cy = -1*Math.max(...yData)/15;

          let circles = [], textAnnotations = [], percentages = [];

          circles.push({
            type: 'rect',
            xref: 'paper',
            yref: 'y',
            x0: -0.2,
            x1: 1,
            y0: cy,
            y1: 8*cy,
            fillcolor: 'rgba(255,255,255,1)',
            line: {width: 0},
          });
          
          for (let i = 0; i < filteredData.length; i++) {
            for (let j = 1; j < 5; j++) {
              var currentgroup = xData[i];
              circles.push({
                type: 'circle',
                xref: 'x',
                x0: i-0.3,
                x1: i+0.3,                
                yref: 'y',
                y0: (j-1)*cy + (j)*cy,
                y1: (j-1)*cy + (j+1)*cy,
                fillcolor:  currentgroup.includes('ABCD'[j-1]) ? colors[i] : 'lightgrey',
                line: {
                  color:  currentgroup.includes('ABCD'[j-1]) ? colors[i] : 'lightgrey',
                }
              })
            };
            // add line through circles
            var yStart = 'ABCD'.indexOf(currentgroup[0]) + 1
            var yEnd = 'ABCD'.indexOf(currentgroup[currentgroup.length - 1]) + 1
            circles.push({
              type: 'line',
              xref: 'x',
              yref: 'y',
              x0: i,
              x1: i,
              y0: (yStart-1)*cy + (yStart)*cy,
              y1: (yEnd-1)*cy + (yEnd+1)*cy,
              line: { color: colors[i], width: 5},
            })
          }


          let sum = 0;

          for (let i = 0; i < yData.length; i++ ) {
            sum += yData[i];
          }

          let tmp = [];

          for (let i = 0; i < yData.length; i++ ) {
            
            textAnnotations.push({
              x: i,
              y: yData[i] - cy*1.3,
              xref: 'x',
              yref: 'y',
              text: `${yData[i]}`,
              showarrow: false,
              // font: {
              //     color: 'cornflowerblue'
              // }
            }),
            textAnnotations.push({
              x: i,
              y: yData[i] - cy*0.6,
              xref: 'x',
              yref: 'y',
              text:  `(${(yData[i]/sum*100) > 1 ? (yData[i]/sum*100).toFixed(1): '<1'}%)`,
              showarrow: false,
              // font: {
              //     color: 'cornflowerblue'
              // }
            });
            tmp.push(`${(yData[i]/sum*100) > 1 ? (yData[i]/sum*100).toFixed(1): '<1'}%`)
          }

          console.log(tmp)
          textAnnotations.push({
            x: -0.1,
            y: Math.max(...yData)/2,
            xref: 'paper',
            yref: 'y',            
            text: 'intersection size',
            showarrow: false,
            textangle: -90,
            font: {
              size: 16
            }
          })

          console.log(textAnnotations)

          const pipelines = [
              { abb: "D", full: "MS²Rescore w chimeric spectra"},
              { abb: "C", full: "MS²Rescore w/o chimeric spectra"},
              { abb: "B", full: "MSAmanda w chimeric spectra"},
              { abb: "A", full: "MSAmanda w/o chimeric spectra"},
          ];

          for (let j = 1; j < 5; j++) {
            textAnnotations.push({
              xref: 'x',
              x: -0.5,
              yref: 'y',
              y: (j-1)*cy + (j+0.5)*cy,
              text: `${pipelines[(4-j)].full}`,
              showarrow: false,
              xanchor: 'right',
            });
          };

          let countData = [], catData = [], textAnnotationsHorizontalBars = [];

          pipelines.forEach((d, j) => {
            let count=0;
            filteredData.forEach((groups) => {
              count += groups.variable.includes(d.abb) ? Number(groups.value) : 0
            })
            d.count = count;
            d.percentage = count/sum*100;
            countData.push(count)
            catData.push(d.abb)
          });

          const xAxisOffset = Math.max(...countData)*1.01

          pipelines.forEach((d, j) => {
            textAnnotationsHorizontalBars.push({
              xref: 'x',
              x: xAxisOffset,
              yref: 'y',
              y: j,
              text: `${d.count} (${(d.percentage).toFixed(1)}%)`,
              xanchor: 'left',
              showarrow: false,
            })
          })

          const horbarsData = [{
            x: countData,
            y: catData,
            type: 'bar',
            orientation: 'h',              
            marker: {
              color: 'rgba(62,62,62,1)',
              // line: {
              //   color: 'rgb(84, 130, 214)',
              //   width: 1.5
              // }
            }
          }];

          const layout = {
            title: {
              text: `${sampleValue} - ${criteriumValue} - ${(100*thresholdValue)}%`
            },
            xaxis: {
              showgrid: false,
              showticklabels: false,
              range: [-0.5, xData.length - 0.5],
            },
            yaxis: {
              showgrid: true,
              tickformatstops: {
                dtickrange: [0, null],
              },
              zeroline: false,
              gridcolor: 'lightgrey',
              nticks: 6,
            },
            autosize: false,
            width: 930,
            height: 900,
            margin: {
              l: 220,
              r: 0,
              b: 200,
              t: 80,
              pad: 4
            },
            separators: ',.',
            shapes: circles,
            annotations: textAnnotations,
          };

          const layoutHorizontalBarChart = {
            xaxis: {
            //   showgrid: false,
            //   showticklabels: false,
              range: [0, xAxisOffset],
              nticks: 2,
              zeroline: {
                color: 'lightgrey'
              },
              gridcolor: 'lightgrey',
              tick0: 0,
            },
            yaxis: {
              // showgrid: false,
              showticklabels: false,
              zeroline: true,
            },
            margin: {
              l: 10,
              r: 150,
              b: 190,
              t: 510,
              pad: 4
            },
            annotations: textAnnotationsHorizontalBars,
            };
          
          // upsetChart.fn = `tda_hist_${sampleValue}_${thresholdValue}`;
          Plotly.newPlot('upsetChart', barsData, layout);
          Plotly.newPlot('horbarChart', horbarsData, layoutHorizontalBarChart);
          console.log('done');
        } catch (error) {
          console.error('Error fetching CSV:', error);
        }
      }}
    </script>

    

  </body>
</html>